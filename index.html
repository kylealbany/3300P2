<html>
<head>
    <title>Voting Records & Region Demographics</title>
<!-- Load the d3 library. -->
    <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
<!-- Load d3 Map Data -->
    <script src="http://d3js.org/topojson.v1.min.js"></script>
<!-- Load Google Fonts & CSS -->
    <link href='https://fonts.googleapis.com/css?family=Bitter' rel='stylesheet' type='text/css'>
    <link href='stylesheet.css' rel='stylesheet' type='text/css'>
<!-- Jquery & JS links go here -->

</head>

<body>

<div class="body-wrapper">
    <div id="title-card">
        <h1> Voting Records and Region Demographics </h1>
        <hr>
        <h3> An Interactive View into American Political Alignments </h3>
    </div>
    <div id="paragraph">
        <p> This is an introductory paragraph that will explain a few things before we go
        into our main plot. It could potentially explain how to use the graph, and maybe 
        even the rationale as to why we are doing this data visualization in the first place.</p>
    </div>
    <div id="mapholder">
        <div id="map">
        </div>
        <div id="info-box">
            <p> Filtering Options </p>
                <div id="slider"></div>
                <div id="dynamic-data"></div>

                 
        </div>
    </div>
</div>
<div class="body-wrapper">
    <hr>
    <p> Bonus stats if we want them... </p>
</div>

<script>
var globalData;
var arrayDone = false;
var globalArray; //~57000 possible codes, use to index vote data by county id

var width = 1000;
var height = 500;


var projection = d3.geo.albersUsa()
	.scale(1000);

var path = d3.geo.path()
	.projection(projection);

var svg = d3.select("#map").append("svg")
    .attr("width", width)
    .attr("height", height);

var zoom = d3.behavior.zoom()
    .translate(projection.translate())
    .scale(projection.scale())
    .scaleExtent([2*height, 8 * height])
    .on("zoom", zoomed);

var g = svg.append("g")
	.call(zoom);

var blueScale = d3.scale.linear()
            .range(['white','blue'])
            .domain([.3,.9]);

var redScale = d3.scale.linear()
            .range(['white','red'])
            .domain([.3,.9]);

d3.json("counties.json", function(error, data){
    if(error){
        console.log(error);
    }
    globalJSON = data
    globalArray = makeJSONArray(globalJSON);
    drawMap();
});

function drawMap(){
d3.json("us.json", function(error, us) {

	g.append("g")
	    .selectAll("path")
    	    .data(topojson.feature(us, us.objects.counties).features)
    	.enter().append("path")
        	.attr("d", path)
        	.style("fill", function(d) {
        		var obj = globalArray[d.id];
        		if(obj == null){
        			return "cccccc";
        		}
        		var party1 = obj["Party1"];
        		var party2 = obj["Party2"];
        		var votes1 = parseInt(obj["Votes1"]);
        		var votes2 = parseInt(obj["Votes2"]);
        		var totalVotes = parseInt(obj["TOTAL VOTES CAST"]);
        		if(party1 == "Dem"){
        			//Dem win
        			if(votes1>votes2){
        				return blueScale((1.0*votes1)/totalVotes);
        			}
        			//GOP win
        			else if(votes2>votes1){
        				return redScale((1.0*votes2)/totalVotes);
        			}
        			//Other win
        			else{
						return "006600";
        			}
        		}
        		else if(party1 == "GOP"){
        			//GOP win
        			if(votes1>votes2){
        				return redScale((1.0*votes1)/totalVotes);
        			}
        			//Dem win
        			else if(votes2>votes1){
        				return blueScale((1.0*votes2)/totalVotes);
        			}
        			//Other win
        			else{
        				return "006600";
        			}
        		}
        		else{
        			console.log("Party didn't match");
        			console.log(obj);
        			console.log(d.id);
        		}
        	 })
        	.style("stroke", "888888")
        	.on('mousedown.log', countyClicked);

	g.append("g")
	    .selectAll("path")
    	    .data(topojson.feature(us, us.objects.states).features)
    	.enter().append("path")
        	.attr("d", path)
        	.style("fill", function(d) {
        		// Sum number of votes for the state and output winning color
        		var id = d.id;
        		var startRange = parseInt(d.id + "000");
        		var endRange = startRange + 1000;

        		///
        		var obj = globalArray[startRange];
        		if(obj == null){
        			console.log(d.id);
        			return "888888";
        		}
        		else if(obj["Party1"] == "Dem"){
        			var demVotes = parseInt(obj["Votes1"]);
        			var gopVotes = parseInt(obj["Votes2"]);
        			var totalVotes = parseInt(obj["TOTAL VOTES CAST"]);
        		}
        		else if(obj["Party1"] == "GOP"){
        			var gopVotes = parseInt(obj["Votes1"]);
        			var demVotes = parseInt(obj["Votes2"]);
        			var totalVotes = parseInt(obj["TOTAL VOTES CAST"]);
        		}
        		else{
        			console.log("error");
        			console.log(obj);
        		}
        		///
        		// var demVotes = 0;
        		// var gopVotes = 0;
        		// var totalVotes = 0;
        		// for(var i = startRange; i < endRange; i++){
        		// 	var obj = globalArray[i];
         	// 		if(obj == null){
        		// 		continue;
        		// 	}
        		// 	else if(obj["Party1"] == "Dem"){
        		// 		demVotes += parseInt(obj["Votes1"]);
        		// 		gopVotes += parseInt(obj["Votes2"]);
        		// 	}
        		// 	else if(obj["Party1"] == "GOP"){
        		// 		gopVotes += parseInt(obj["Votes1"]);
        		// 		demVotes += parseInt(obj["Votes2"]);
        		// 	}
        		// 	else{
        		// 		console.log("Party didn't match");
        		// 		console.log(obj);
        		// 		console.log(d.id);
        		// 	} 
        		// 	totalVotes += (parseInt(obj["TOTAL VOTES CAST"]));     			
        		// }
        		if (demVotes > gopVotes){
        			var scaleInput = (demVotes)/totalVotes;
        			return blueScale(scaleInput);
        		}
        		else if (gopVotes > demVotes){
        			var scaleInput = (gopVotes)/totalVotes;
        			return redScale(scaleInput);
        		}
        		else{
        			return "cccccc";
        		}
        		
        	})
        	.style("stroke", "888888")
        	.on('mousedown.log', stateClicked);


});
}

var currentState;
var currentCounty;

//Zoom in to county view of state when it is clicked
function stateClicked(d) {
	var x, y;
	var zoom = 3;

	if(currentState != null){
		currentState.attr("display", "initial");
	}
	
	currentState = d3.select(this);
	currentState.attr("display", "none");

    var centroid = path.centroid(d);
    x = centroid[0];
    y = centroid[1];

	g.transition()
      .duration(1000)
      .attr("transform", "translate(" + width/2 + "," + height/2 + ")scale(" + zoom + ")translate(" + -x + "," + -y + ")");

    // Code to change the information in the infobox
    var info_box = d3.select("#dynamic-data");
    

}

//Change function later, currently zooms out to state view and logs county id when clicked
function countyClicked(d){
	console.log(d.id);


	if(currentState != null){
		currentState.attr("display", "initial");
	}

	g.transition()
      .duration(1000)
      .attr("transform", "scale(" + 1 + ")");
      

    var obj = globalArray[d.id];
    // Write county info to the infobox
    var infobox = d3.select("#dynamic-data");
    infobox.html('');
    //BS Variables that need set later on
    var countyvar = obj["County Name"];
    var income = obj["Median Household Income"];
    
    var totalVotes = parseInt(obj["TOTAL VOTES CAST"]);
    if(obj["Party1"] == "Dem"){
    	var demVotes = parseInt(obj["Votes1"]);
    	var gopVotes = parseInt(obj["Votes2"]);
    }
    else if(obj["Party1"] == "GOP"){
    	var gopVotes = parseInt(obj["Votes1"]);
    	var demVotes = parseInt(obj["Votes2"]);
    }
    else{
    	console.log("error party names");
    }

    var Obamavar = ((100 * demVotes)/totalVotes).toFixed(2);
    var Romneyvar = ((100 * gopVotes)/totalVotes).toFixed(2);
    var Othervar = (100 - Obamavar - Romneyvar).toFixed(2);

    // Infobox writing
    infobox.append('p')
        .text('County: ' + countyvar);
    infobox.append('p')
        .text('Obama: ' + Obamavar + "%")
        .append('svg')
        .append('rect')
        .attr("class",'dem_rect')
        .attr('width', 2*Obamavar);
    infobox.append('p')
        .text('Romney: ' + Romneyvar + "%")
        .append('svg')
        .append('rect')
        .attr("class",'rep_rect')
        .attr('width', 2*Romneyvar);
    infobox.append('p')
        .text('Other: ' + Othervar + "%")
        .append('svg')
        .append('rect')
        .attr("class",'other_rect')
        .attr('width', 2*Othervar);
    infobox.append('p')
        .text("Median Household Income: $" + income);

}

//Color in the county that is clicked on
function colorCounty(d){
	currentCounty = d3.select(this);
	currentCounty.style("fill", "FF0000");
}

//Currently just a copy of the functionality for countyClicked to zoom back to state level
function zoomOut(){

	if(currentState != null){
		currentState.attr("display", "initial");
	}

	g.transition()
      .duration(1000)
      .attr("transform", "scale(" + 1 + ")");
}

//Used for d3 mousewheel scrolling
function zoomed() {
  projection.translate(d3.event.translate).scale(d3.event.scale);
  g.selectAll("path").attr("d", path);
}


//Not correct yet, issues because of string/int types and concatenation instead of adding
function makeJSONArray(json) {
	console.log("starting to make array");
	var array = new Array();
	for(var i = 0; i < json.length; i++){
		var obj = json[i];
		var idx = parseInt(obj["FIPS Codes"]);
		array[idx] = obj;
	}
	console.log("Made JSON Array");
	return array;
}

</script>
</body>
</html>