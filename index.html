<html>
<head>
    <title>Voting Records & Region Demographics</title>
<!-- Load the d3 library. -->
    <script src="http://d3js.org/d3.v3.min.js" charset="utf-8"></script>
<!-- Load d3 Map Data -->
    <script src="http://d3js.org/topojson.v1.min.js"></script>
<!-- Load Google Fonts & CSS -->
    <link href='https://fonts.googleapis.com/css?family=Bitter' rel='stylesheet' type='text/css'>
    <link href='stylesheet.css' rel='stylesheet' type='text/css'>
<!-- Jquery & JS links go here -->

<!-- Load the Master JSON file  & Restructure it -->
    <script>
    var globalData;
    var globalArray; //~57000 possible codes, use to index vote data by county id
    d3.json("fixedCodes.json", function(error, data){
        if(error){
            console.log(error);
        }
        globalJSON = data
        globalArray = makeJSONArray(globalJSON);
    });
    var globalCount = 0;
    var globalJSON;

    </script>
</head>

<body>

<div class="body-wrapper">
    <div id="title-card">
        <h1> Voting Records and Region Demographics </h1>
        <hr>
        <h3> An Interactive View into American Political Alignments </h3>
    </div>
    <div id="paragraph">
        <p> This is an introductory paragraph that will explain a few things before we go
        into our main plot. It could potentially explain how to use the graph, and maybe 
        even the rationale as to why we are doing this data visualization in the first place.</p>
    </div>
    <div id="mapholder">
        <div id="map">
        </div>
        <div id="info-box">
            <p> Filtering Options </p>
                <div id="slider"></div>
                <div id="dynamic-data"></div>
        </div>
    </div>
</div>
<div class="body-wrapper">
    <hr>
    <p> Bonus stats if we want them... </p>
</div>

<script>
var width = 1000;
var height = 500;


var projection = d3.geo.albersUsa()
	.scale(1000);

var path = d3.geo.path()
	.projection(projection);

var svg = d3.select("#map").append("svg")
    .attr("width", width)
    .attr("height", height);

var zoom = d3.behavior.zoom()
    .translate(projection.translate())
    .scale(projection.scale())
    .scaleExtent([2*height, 8 * height])
    .on("zoom", zoomed);

var g = svg.append("g")
	.call(zoom);


d3.json("us.json", function(error, us) {


	g.append("g")
	    .selectAll("path")
    	    .data(topojson.feature(us, us.objects.counties).features)
    	.enter().append("path")
        	.attr("d", path)
        	.style("fill", function(d) {
        		var obj = globalArray[d.id];
        		globalCount += 1;
        		if(obj == null){
        			return "cccccc";
        		}
        		if(obj["Party1"] == "Dem"){
        			//Dem win
        			if(parseInt(obj["Votes1"])>parseInt(obj["Votes2"])){
        				return "0000ff";
        			}
        			//GOP win
        			else if(parseInt(obj["Votes2"])>parseInt(obj["Votes1"])){
        				return "ff0000";
        			}
        			//Other win
        			else{
						return "006600";
        			}
        		}
        		else if(obj["Party1"] == "GOP"){
        			//GOP win
        			if(parseInt(obj["Votes1"])>parseInt(obj["Votes2"])){
        				return "ff0000";
        			}
        			//Dem win
        			else if(parseInt(obj["Votes2"])>parseInt(obj["Votes1"])){
        				return "0000ff";
        			}
        			//Other win
        			else{
        				return "006600";
        			}
        		}
        		else{
        			console.log("Party didn't match");
        			console.log(obj);
        			console.log(d.id);
        		}
        	 })
        	.style("stroke", "888888")
        	.on('mousedown.log', countyClicked);

	g.append("g")
	    .selectAll("path")
    	    .data(topojson.feature(us, us.objects.states).features)
    	.enter().append("path")
        	.attr("d", path)
        	.style("fill", function(d) {
        		// Sum number of votes for the state and output winning color
        		var id = d.id;
        		var startRange = parseInt(d.id + "000");
        		var endRange = startRange + 1000;
        		var demVotes = 0;
        		var gopVotes = 0;
        		for(var i = startRange; i < endRange; i++){
        			var obj = globalArray[i];
         			if(obj == null){
        				continue;
        			}
        			else if(obj["Party1"] == "Dem"){
        				demVotes += parseInt(obj["Votes1"]);
        				gopVotes += parseInt(obj["Votes2"]);
        			}
        			else if(obj["Party1"] == "GOP"){
        				gopVotes += parseInt(obj["Votes1"]);
        				demVotes += parseInt(obj["Votes2"]);
        			}
        			else{
        				console.log("Party didn't match");
        				console.log(obj);
        				console.log(d.id);
        			}       			
        		}
        		if (gopVotes > demVotes){
        			return "ff0000";
        		}
        		else if (demVotes > gopVotes){
        			return "0000ff";
        		}
        		else{
        			console.log("demVotes vs gopVotes error");
        			console.log(demVotes);
        			console.log(gopVotes);
        		}
        	})
        	.style("stroke", "888888")
        	.on('mousedown.log', stateClicked);


});

var currentState;
var currentCounty;

//Zoom in to county view of state when it is clicked
function stateClicked(d) {
	var x, y;
	var zoom = 3;

	if(currentState != null){
		currentState.attr("display", "initial");
	}
	
	currentState = d3.select(this);
	currentState.attr("display", "none");

    var centroid = path.centroid(d);
    x = centroid[0];
    y = centroid[1];

	g.transition()
      .duration(1000)
      .attr("transform", "translate(" + width/2 + "," + height/2 + ")scale(" + zoom + ")translate(" + -x + "," + -y + ")");


}

//Change function later, currently zooms out to state view and logs county id when clicked
function countyClicked(d){
	console.log(d.id);


	if(currentState != null){
		currentState.attr("display", "initial");
	}

	g.transition()
      .duration(1000)
      .attr("transform", "scale(" + 1 + ")");
      
    // Write county info to the infobox
    var infobox = d3.select("#dynamic-data");
    
}

//Color in the county that is clicked on
function colorCounty(d){
	currentCounty = d3.select(this);
	currentCounty.style("fill", "FF0000");
}

//Currently just a copy of the functionality for countyClicked to zoom back to state level
function zoomOut(){

	if(currentState != null){
		currentState.attr("display", "initial");
	}

	g.transition()
      .duration(1000)
      .attr("transform", "scale(" + 1 + ")");
}

//Used for d3 mousewheel scrolling
function zoomed() {
  projection.translate(d3.event.translate).scale(d3.event.scale);
  g.selectAll("path").attr("d", path);
}


//Not correct yet, issues because of string/int types and concatenation instead of adding
function makeJSONArray(json) {
	var array = new Array(57000);
	for(var i = 0; i < json.length; i++){
		var obj = json[i];
		var idx = parseInt(obj["County FIPS Code"]);
		array[idx] = obj;
	}
	return array;
}

//Takes county code/state postals from json and formats them to match us.json
function fixFIPS(json) {
	//If it is a 1 or 2 digit code, pad it with 0's
	for(var i = 0; i < json.length; i++) {
		var obj=json[i];
		if(parseInt(obj["County FIPS Code"]) < 10){
			obj["County FIPS Code"] = "00" + obj["County FIPS Code"];
		}
		else if (parseInt(obj["County FIPS Code"]) < 100){
			obj["County FIPS Code"] = "0" + obj["County FIPS Code"];
		}
	}
	//Add on the first two digits of the FIPS code, which are for the state
	for(var i = 0; i < json.length; i++) {
		var obj=json[i];
		if (obj["State Postal"] == "AK"){
			obj["County FIPS Code"] = "2" + obj["County FIPS Code"];
		}
		else if (obj["State Postal"] == "AL"){
			obj["County FIPS Code"] = "1" + obj["County FIPS Code"];
		}
		else if (obj["State Postal"] == "AR"){
			obj["County FIPS Code"] = "5" + obj["County FIPS Code"];
		}
		else if (obj["State Postal"] == "AZ"){
			obj["County FIPS Code"] = "4" + obj["County FIPS Code"];
		}
		else if (obj["State Postal"] == "CA"){
			obj["County FIPS Code"] = "6" + obj["County FIPS Code"];
		}
		else if (obj["State Postal"] == "CO"){
			obj["County FIPS Code"] = "8" + obj["County FIPS Code"];
		}
		else if (obj["State Postal"] == "CT"){
			obj["County FIPS Code"] = "9" + obj["County FIPS Code"];
		}
		else if (obj["State Postal"] == "DC"){
			obj["County FIPS Code"] = "11" + obj["County FIPS Code"];
		}
		else if (obj["State Postal"] == "DE"){
			obj["County FIPS Code"] = "10" + obj["County FIPS Code"];
		}
		else if (obj["State Postal"] == "FL"){
			obj["County FIPS Code"] = "12" + obj["County FIPS Code"];
		}
		else if (obj["State Postal"] == "GA"){
			obj["County FIPS Code"] = "13" + obj["County FIPS Code"];
		}
		else if (obj["State Postal"] == "HI"){
			obj["County FIPS Code"] = "15" + obj["County FIPS Code"];
		}
		else if (obj["State Postal"] == "IA"){
			obj["County FIPS Code"] = "19" + obj["County FIPS Code"];
		}
		else if (obj["State Postal"] == "ID"){
			obj["County FIPS Code"] = "16" + obj["County FIPS Code"];
		}
		else if (obj["State Postal"] == "IL"){
			obj["County FIPS Code"] = "17" + obj["County FIPS Code"];
		}
		else if (obj["State Postal"] == "IN"){
			obj["County FIPS Code"] = "18" + obj["County FIPS Code"];
		}
		else if (obj["State Postal"] == "KS"){
			obj["County FIPS Code"] = "20" + obj["County FIPS Code"];
		}
		else if (obj["State Postal"] == "KY"){
			obj["County FIPS Code"] = "21" + obj["County FIPS Code"];
		}
		else if (obj["State Postal"] == "LA"){
			obj["County FIPS Code"] = "22" + obj["County FIPS Code"];
		}
		else if (obj["State Postal"] == "MA"){
			obj["County FIPS Code"] = "25" + obj["County FIPS Code"];
		}
		else if (obj["State Postal"] == "MD"){
			obj["County FIPS Code"] = "24" + obj["County FIPS Code"];
		}
		else if (obj["State Postal"] == "ME"){
			obj["County FIPS Code"] = "23" + obj["County FIPS Code"];
		}
		else if (obj["State Postal"] == "MI"){
			obj["County FIPS Code"] = "26" + obj["County FIPS Code"];
		}
		else if (obj["State Postal"] == "MN"){
			obj["County FIPS Code"] = "27" + obj["County FIPS Code"];
		}
		else if (obj["State Postal"] == "MO"){
			obj["County FIPS Code"] = "29" + obj["County FIPS Code"];
		}
		else if (obj["State Postal"] == "MS"){
			obj["County FIPS Code"] = "28" + obj["County FIPS Code"];
		}
		else if (obj["State Postal"] == "MT"){
			obj["County FIPS Code"] = "30" + obj["County FIPS Code"];
		}
		else if (obj["State Postal"] == "NC"){
			obj["County FIPS Code"] = "37" + obj["County FIPS Code"];
		}
		else if (obj["State Postal"] == "ND"){
			obj["County FIPS Code"] = "38" + obj["County FIPS Code"];
		}
		else if (obj["State Postal"] == "NE"){
			obj["County FIPS Code"] = "31" + obj["County FIPS Code"];
		}
		else if (obj["State Postal"] == "NH"){
			obj["County FIPS Code"] = "33" + obj["County FIPS Code"];
		}
		else if (obj["State Postal"] == "NJ"){
			obj["County FIPS Code"] = "34" + obj["County FIPS Code"];
		}
		else if (obj["State Postal"] == "NM"){
			obj["County FIPS Code"] = "35" + obj["County FIPS Code"];
		}
		else if (obj["State Postal"] == "NV"){
			obj["County FIPS Code"] = "32" + obj["County FIPS Code"];
		}
		else if (obj["State Postal"] == "NY"){
			obj["County FIPS Code"] = "36" + obj["County FIPS Code"];
		}
		else if (obj["State Postal"] == "OH"){
			obj["County FIPS Code"] = "39" + obj["County FIPS Code"];
		}
		else if (obj["State Postal"] == "OK"){
			obj["County FIPS Code"] = "40" + obj["County FIPS Code"];
		}
		else if (obj["State Postal"] == "OR"){
			obj["County FIPS Code"] = "41" + obj["County FIPS Code"];
		}
		else if (obj["State Postal"] == "PA"){
			obj["County FIPS Code"] = "42" + obj["County FIPS Code"];
		}
		else if (obj["State Postal"] == "RI"){
			obj["County FIPS Code"] = "44" + obj["County FIPS Code"];
		}
		else if (obj["State Postal"] == "SC"){
			obj["County FIPS Code"] = "45" + obj["County FIPS Code"];
		}
		else if (obj["State Postal"] == "SD"){
			obj["County FIPS Code"] = "46" + obj["County FIPS Code"];
		}
		else if (obj["State Postal"] == "TN"){
			obj["County FIPS Code"] = "47" + obj["County FIPS Code"];
		}
		else if (obj["State Postal"] == "TX"){
			obj["County FIPS Code"] = "48" + obj["County FIPS Code"];
		}
		else if (obj["State Postal"] == "UT"){
			obj["County FIPS Code"] = "49" + obj["County FIPS Code"];
		}
		else if (obj["State Postal"] == "VA"){
			obj["County FIPS Code"] = "51" + obj["County FIPS Code"];
		}
		else if (obj["State Postal"] == "VT"){
			obj["County FIPS Code"] = "50" + obj["County FIPS Code"];
		}
		else if (obj["State Postal"] == "WA"){
			obj["County FIPS Code"] = "53" + obj["County FIPS Code"];
		}
		else if (obj["State Postal"] == "WI"){
			obj["County FIPS Code"] = "55" + obj["County FIPS Code"];
		}
		else if (obj["State Postal"] == "WV"){
			obj["County FIPS Code"] = "54" + obj["County FIPS Code"];
		}
		else if (obj["State Postal"] == "WY"){
			obj["County FIPS Code"] = "56" + obj["County FIPS Code"];
		}
		else {
			console.log(obj);
		}
	}
	return json;
}

</script>
<div id="test"></div>
</body>
</html>